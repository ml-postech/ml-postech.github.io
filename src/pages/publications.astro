---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import "@citation-js/plugin-bibtex";
import "@citation-js/plugin-csl";

const publications = (await getCollection("publications")).toSorted((a, b) => {
  if (a.data.issued && b.data.issued && a.data.issued !== b.data.issued) {
    return b.data.issued.getTime() - a.data.issued.getTime();
  }
  return a.data.title.localeCompare(b.data.title);
});

const categories = [
  "All",
  ...[
    ...new Set(
      publications.flatMap((publication) => publication.data.category),
    ),
  ].sort(),
];
---

<Layout>
  <main class:list={[]}>
    <div
      class:list={[
        "px-6 md:px-10",
        "mt-[160px] mb-[80px] md:mb-[128px]",
        "grid grid-cols-1 md:grid-cols-12 gap-4",
      ]}
    >
      <h1
        class:list={[
          "col-span-8",
          "font-serif",
          "text-[60px] md:text-[120px]",
          "font-bold",
          "-mt-8",
        ]}
      >
        Publications
      </h1>
      <p class:list={["col-span-4", "text-2xl"]}>
        From core algorithms and theoretical insights to applied systems
        tackling perception, language, and decision making.
      </p>
    </div>
    <ul class:list={["px-6 md:px-10", "flex", "gap-4", "mb-4", "flex-wrap"]}>
      {
        categories.map((category) => (
          <li class:list={["inline", "text-sm"]}>
            <a
              href={`#${category}`}
              class:list={[
                "border border-black/50",
                "px-2",
                "py-1",
                "capitalize",
              ]}
            >
              {category}
            </a>
          </li>
        ))
      }
    </ul>
    <ul
      class:list={["px-6 md:px-10", "space-y-10", "mb-20"]}
      id="publications-list"
    >
      {
        publications.map((publication) => (
          <li
            class:list={[
              "border-t border-black/50",
              "pt-4",
              "publication-item",
            ]}
            data-category={publication.data.category}
          >
            <h2 class:list={["font-medium", "text-xl"]}>
              {publication.data.title}
            </h2>
            <p class:list={["text-sm"]}>{publication.data.containerTitle}</p>
            <p class:list={["text-sm", "italic"]}>
              {publication.data.authors
                .map((a: any) => `${a.given} ${a.family}`)
                .join(", ")}
            </p>
          </li>
        ))
      }
    </ul>
  </main>
</Layout>

<script>
  // Filter publications based on selected category
  function filterPublications() {
    const hash = window.location.hash.substring(1) || "All";
    const selectedCategory = hash.toLowerCase();
    const publications = document.querySelectorAll(".publication-item");

    publications.forEach((pub) => {
      const element = pub as HTMLElement;
      const category = element.getAttribute("data-category") || "";

      if (
        selectedCategory === "all" ||
        category.toLowerCase() === selectedCategory
      ) {
        element.style.display = "";
      } else {
        element.style.display = "none";
      }
    });
  }

  // Fill black tag background if hash matches, on hash change or page load
  function updateTagHighlight() {
    const hash = window.location.hash.substring(1) || "All";
    document.querySelectorAll("ul li a").forEach((el) => {
      const href = el.getAttribute("href");
      if (href === `#${hash}`) {
        el.classList.add("bg-black", "text-white");
      } else {
        el.classList.remove("bg-black", "text-white");
      }
    });
  }

  function updatePage() {
    updateTagHighlight();
    filterPublications();
  }

  window.addEventListener("hashchange", updatePage);
  window.addEventListener("load", updatePage);
</script>
